<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Laptop Detailed View</title>
    <style>
      html,
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      *,
      *::before,
      *::after {
        font-family: inherit;
      }
      ::placeholder {
        font-family: inherit;
      }

      form {
        width: 60%;
        margin: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
        font-size: 16px;
      }
      .group label {
        width: 160px;
        font-weight: bold;
      }
      input,
      select {
        flex: 1;
        padding: 8px;
        font-size: 14px;
      }
      button#save {
        padding: 10px;
        background-color: #333;
        color: white;
        border: 5px solid #333;
        cursor: pointer;
        font-size: 14px;
      }
      button#dateButton {
        background-color: #e7e7e7;
        color: rgb(51, 51, 51);
        font-size: 14px;
        padding: 8px 10px;
        cursor: pointer;
      }
      h2 {
        text-align: center;
      }
      :root {
        --app-font: Arial, Helvetica, sans-serif;
      }
      html,
      body {
        font-family: var(--app-font);
      }
      *,
      *::before,
      *::after {
        font-family: inherit;
      }

      button,
      input,
      select,
      textarea {
        font: inherit;
      }

      ::placeholder {
        font-family: inherit;
      }

      .danger {
        background: #c62828;
        color: #fff;
        border: 1px solid #b71c1c;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
      }
      .danger:hover {
        filter: brightness(0.95);
      }
    </style>
  </head>

  <body>
    <h2>Edit Laptop Details</h2>

    <button onclick="location.href='webSite.html'">Back To Home</button>

    <form id="editLaptopForm">
      <a
        href="#"
        onclick="this.href = 'historyLog.html?pcNumber=' + document.querySelector('input[name=pcNumber]').value"
      >
        View History Log</a
      >
      <div class="group">
        <label for="procured">Procured Date:</label>
        <input id="procured" name="procured" placeholder="Procured Date" />
      </div>

      <div class="group">
        <label for="deviceInfo">Device Info:</label>
        <input id="deviceInfo" name="deviceInfo" placeholder="Device Info" />
      </div>

      <div class="group">
        <label for="pcNumber">PC Number:</label>
        <input id="pcNumber" name="pcNumber" placeholder="PC Number" readonly />
      </div>

      <div class="group">
        <label for="location">Location Type:</label>
        <input id="location" name="location" placeholder="Location Type" />
      </div>

      <div class="group">
        <label for="serialNum">Serial Number:</label>
        <input id="serialNum" name="serialNum" placeholder="Serial Number" />
      </div>

      <div class="group">
        <label for="price">Price:</label>
        <input
          id="price"
          name="price"
          type="number"
          step="0.01"
          placeholder="Price"
        />
      </div>

      <div class="group">
        <label for="notes">Notes:</label>
        <input id="notes" name="notes" placeholder="Notes" />
      </div>

      <div class="group">
        <label for="email">Email:</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>

      <div class="group">
        <label for="password">Password:</label>
        <input
          id="password"
          name="password"
          type="password"
          placeholder="Password"
        />
      </div>

      <div class="group">
        <label for="userID">User ID:</label>
        <input id="userID" name="userID" placeholder="User ID" />
      </div>

      <div class="group">
        <label for="anyDesk">AnyDesk ID:</label>
        <input
          id="anyDesk"
          name="anyDesk"
          type="number"
          placeholder="AnyDesk ID"
        />
      </div>

      <div class="group">
        <label for="r3thaVersion">R3THA Version:</label>
        <input
          id="r3thaVersion"
          name="r3thaVersion"
          placeholder="R3THA Version"
        />
      </div>

      <div class="group">
        <label for="lastUpdate">Last Update:</label>
        <input
          id="lastUpdate"
          name="lastUpdate"
          type="date"
          placeholder="Last Update"
        />
        <button type="button" id="dateButton" onclick="setTodayDate()">
          Set to Today
        </button>
      </div>

      <div class="group">
        <label for="status">Status:</label>
        <select name="status" id="status">
          <option value="true">Available</option>
          <option value="false">In Use</option>
        </select>
      </div>

      <div class="group">
        <button id="save" type="submit">Save Changes</button>
      </div>

      <script>
        function setTodayDate() {
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("lastUpdate").value = today;
        }
      </script>

      <div class="group">
        <label>Danger Zone:</label>
        <div style="flex: 1">
          <input id="deleteConfirm" placeholder="Type DELETE to confirm" />
          <button id="deleteBtn" class="danger" type="button">
            Delete Laptop
          </button>
          <div style="font-size: 12px; color: #666; margin-top: 6px">
            Permanently removes PC <span id="pcLabel"></span>.
          </div>
        </div>
      </div>
    </form>
    <script>
      const API_BASE = "https://inventoryapptest-production.up.railway.app";

      const urlParams = new URLSearchParams(window.location.search);
      const pcNumber = urlParams.get("pcNumber");

      async function loadLaptopDetails() {
        const res = await fetch(
          `${API_BASE}/api/LapTop/${encodeURIComponent(pcNumber)}`
        );
        const laptop = await res.json();
        const form = document.getElementById("editLaptopForm");
        for (const field in laptop) {
          if (form.elements[field])
            form.elements[field].value = laptop[field] || "";
        }
        // show which PC will be deleted
        document.getElementById("pcLabel").textContent = pcNumber || "";
        // if we came from the red delete button, focus the confirm box
        if (urlParams.get("action") === "delete") {
          document.getElementById("deleteConfirm").focus();
        }
      }

      document
        .getElementById("editLaptopForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = Object.fromEntries(formData.entries());
          data.price = parseFloat(data.price);
          data.anyDesk = parseInt(data.anyDesk, 10);
          data.status = data.status === "true";

          const res = await fetch(
            `${API_BASE}/api/LapTop/${encodeURIComponent(data.pcNumber)}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            }
          );

          if (res.ok) {
            alert("Laptop updated successfully!");
            window.location.href = "webSite.html";
          } else {
            alert("Error updating laptop.");
          }
        });

      // DELETE with "type DELETE" confirmation
      document
        .getElementById("deleteBtn")
        .addEventListener("click", async () => {
          const conf = document.getElementById("deleteConfirm").value.trim();
          if (conf !== "DELETE") {
            alert("Please type DELETE to confirm.");
            document.getElementById("deleteConfirm").focus();
            return;
          }
          try {
            const r = await fetch(
              `${API_BASE}/api/LapTop/${encodeURIComponent(pcNumber)}`,
              { method: "DELETE" }
            );
            const msg = await r.text();
            if (!r.ok) throw new Error(msg || "Delete failed");
            alert(msg || "Laptop deleted.");
            location.href = "webSite.html";
          } catch (e) {
            console.error(e);
            alert("Failed to delete laptop.");
          }
        });

      loadLaptopDetails();
    </script>
  </body>
</html>
